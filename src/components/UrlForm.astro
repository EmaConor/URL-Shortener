<section
  transition:name="iosForm"
  class="animate-pop rounded-[12px] border border-white/10 bg-white/2 p-8 shadow-xl/20 backdrop-blur-none"
>
  <div class="mb-6 flex items-center gap-3">
    <div class="flex gap-2">
      <div class="h-3 w-3 rounded-full bg-red-500"></div>
      <div class="h-3 w-3 rounded-full bg-yellow-500"></div>
      <div class="h-3 w-3 rounded-full bg-green-500"></div>
    </div>
    <span class="text-sm text-slate-300">Inserta tu URL aquí</span>
  </div>
  <form id="shorten-form" class="mt-6 items-center gap-3">
    <div class="flex flex-col sm:flex-row">
      <input
        type="url"
        name="url"
        id="url"
        required
        placeholder="https://tu-enlace-muy-largo.com/con/muchos/parametros"
        class="mr-4 mb-3 w-full rounded-xl bg-[#1E293B] px-4 py-3 text-slate-300 outline-none sm:mb-0"
      />
      <button
        type="submit"
        class="w-full cursor-pointer rounded-lg bg-linear-to-r from-purple-500 to-blue-500 px-8 shadow-lg shadow-purple-500/25 transition-all hover:scale-105 hover:from-purple-600 hover:to-blue-600 sm:w-auto"
      >
        Acortar URL
      </button>
    </div>

    <div
      id="message"
      class="mt-4 flex hidden items-center justify-between rounded-xl border-2 border-purple-500/30 bg-[#1E293B] p-3"
    >
      <span class="text-purple-300"
        ><i class="ti ti-unlink p-2"></i>
        Tu URL acortada es: <span id="short-url" class="font-mono break-all text-blue-300"></span>
      </span>

      <div class="flex items-center gap-2">
        <button
          type="button"
          id="btn-copy"
          class="rounded-md p-1 transition-colors hover:bg-white/10"
          title="Copiar"
        >
          <i class="ti ti-copy w-7 text-[20px] text-blue-300"></i>
        </button>
        <a
          id="btn-open"
          href="#"
          target="_blank"
          class="rounded-md p-1 transition-colors hover:bg-white/10"
          title="Abrir enlace"
        >
          <i class="ti ti-external-link w-6 text-[20px] text-purple-400"></i>
        </a>
      </div>
    </div>

    <div
      id="error-message"
      class="mt-4 flex hidden items-center justify-between rounded-xl border-2 border-red-500/30 bg-red-900/50 p-3"
    >
      <span class="text-red-300"
        ><i class="ti ti-alert-circle p-2"></i>
        <span id="error-text"></span>
      </span>
    </div>
  </form>
</section>

<script>
  import { actions, isInputError } from 'astro:actions'
  
  document.addEventListener('astro:page-load', () => {
    // Elementos del DOM
    const shortenForm = document.getElementById('shorten-form') as HTMLFormElement

    // Mensaje de éxito
    const messageDiv = document.getElementById('message') as HTMLDivElement
    const shortUrlSpan = document.getElementById('short-url') as HTMLSpanElement
    const btnCopy = document.getElementById('btn-copy') as HTMLButtonElement
    const btnOpen = document.getElementById('btn-open') as HTMLAnchorElement

    // Mensaje de error
    const errorMessageDiv = document.getElementById('error-message') as HTMLDivElement
    const errorTextSpan = document.getElementById('error-text') as HTMLSpanElement

    btnCopy.addEventListener('click', () => {
      const fullShortUrl = btnOpen.href
      navigator.clipboard.writeText(fullShortUrl)
      const icon = btnCopy.querySelector('i')
      if (icon) {
        const originalClass = icon.className
        icon.className = 'w-7 text-[20px] text-blue-400 ti ti-copy-check'
        setTimeout(() => {
          icon.className = originalClass
        }, 2000)
      }
    })

    function showMessage(shortURL: string) {
      const fullShortUrl = `${window.location.origin}/${shortURL}`
      shortUrlSpan.textContent = fullShortUrl
      btnOpen.href = `/${shortURL}`
      messageDiv.classList.remove('hidden')
    }

    function showErrorMessage(message: string) {
      errorTextSpan.textContent = message
      errorMessageDiv.classList.remove('hidden')
    }

    shortenForm.addEventListener('submit', async (e) => {
      e.preventDefault()

      // Ocultar mensajes previos
      messageDiv.classList.add('hidden')
      errorMessageDiv.classList.add('hidden')

      const formData = new FormData(shortenForm)

      if (formData) {
        await setShortUrl(formData)
      }
    })

    async function setShortUrl(formData: FormData) {
      try {
        const url = formData.get('url') as string
        const { data, error } = await actions.setShortUrl({ url })

        if (error) {
          if (isInputError(error)) {
            // Zod validation error
            if (error.fields.url && error.fields.url.length > 0) {
              showErrorMessage(error.fields.url[0])
            } else {
              showErrorMessage('Error de validación en la URL.') // Fallback message
            }
          } else {
            // Other errors thrown from the handler
            showErrorMessage(error.message)
          }
          return
        }

        if (data) {
          showMessage(data.shortCode)
        }
      } catch (error) {
        console.error('Error inesperado en el cliente:', error)
        showErrorMessage('Ocurrió un error inesperado. Por favor, intenta de nuevo.')
      }
    }
  })
</script>

---
import { Key, Link, Lock, Tag } from '@/icons'
import colors from '@/db/seeds/data/colors.json'

import { db } from '@/db'
import { shortUrl, tag } from '@/db/schema'
import { type SQL, eq, and, like, or } from 'drizzle-orm'
const { user } = Astro.locals
if (!user) throw new Error('User is required')

const tags = await db.select().from(tag).where(eq(tag.userId, user.id))
---

<section
  transition:name="iosForm"
  class="animate-pop mx-auto max-w-5xl rounded-[12px] border border-white/10 bg-white/5 p-5 shadow-xl/20 backdrop-blur-sm"
>
  <div class="mb-6 flex items-center gap-3">
    <div class="flex gap-2">
      <div class="h-3 w-3 rounded-full bg-red-500"></div>
      <div class="h-3 w-3 rounded-full bg-yellow-500"></div>
      <div class="h-3 w-3 rounded-full bg-green-500"></div>
    </div>
    <span class="text-md text-slate-300">Crea tu Link acortado</span>
  </div>

  <form id="shorten-form" class="mt-6 items-center gap-3 space-y-4">
    <div>
      <label class="mb-2 block text-sm text-slate-400">Pega aquí tu Link largo</label>
      <div class="relative">
        <input
          type="url"
          name="url"
          id="url"
          required
          placeholder="https://tu-enlace-muy-largo.com/con/muchos/parametros"
          class="w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 text-slate-300 transition-colors outline-none placeholder:text-slate-500 focus:border-purple-500/30 focus:outline-none sm:mb-0"
        />
        <Link class="absolute top-3.5 right-3 h-5 w-5 text-slate-400" />
      </div>

      <div class="flex gap-4 py-4">
        <div
          class="flex w-1/2 items-center justify-between rounded-lg border border-white/10 bg-white/5 p-3"
        >
          <div class="flex items-center gap-2">
            <Lock class="top-1/2 left-4 w-5 text-purple-400" />
            <span class="text-sm">Password Protection</span>
          </div>
          <label class="group flex cursor-pointer items-center gap-3">
            <div class="relative flex items-center">
              <input type="checkbox" id="password-check" class="peer sr-only" />
              <div
                class="h-6 w-6 rounded-md border border-white/20 bg-white/5 transition-all duration-300 group-hover:border-purple-500/50 peer-checked:border-transparent peer-checked:bg-linear-to-r peer-checked:from-purple-500 peer-checked:to-blue-500"
              >
              </div>
            </div>
          </label>
        </div>
        <div class="relative w-1/3">
          <Tag class="absolute top-1/2 left-4 w-5 -translate-y-1/2 text-purple-400" />
          <select
            id="tag-select"
            name="tagId"
            class="flex w-full cursor-pointer appearance-none items-center justify-between rounded-lg border border-white/10 bg-white/5 p-3 py-3 pr-8 pl-12 transition-colors focus:border-purple-500/30 focus:outline-none"
            ><option class="bg-slate-900 text-white" value="" disabled selected
              >Selecciona un tag</option
            >
            {
              tags.map((tag) => {
                return (
                  <option style={{ backgroundColor: tag.color, color: 'white' }} value={tag.id}>
                    {tag.name}
                  </option>
                )
              })
            }
          </select>
        </div>
        <button
          id="add-tag"
          type="button"
          class="flex w-1/6 cursor-pointer items-center justify-between rounded-lg bg-linear-to-r from-purple-500 to-blue-500 px-5 shadow-lg shadow-purple-500/25 transition-all hover:scale-105 hover:from-purple-600 hover:to-blue-600"
        >
          Añadir Tag
        </button>
      </div>
      <div id="passForm" class="mb-4 hidden">
        <div class="group relative">
          <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
            <Key class="text-2xl text-gray-400" />
          </div>
          <input
            id="password"
            name="password"
            type="password"
            placeholder="Ingresa la contraseña de la URL*"
            class="mr-4 block w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 pr-12 pl-12 text-slate-300 transition-colors outline-none placeholder:text-slate-500 focus:border-purple-500/30 focus:outline-none sm:mb-0"
          />
        </div>

        <div id="confirmPassForm" class="group relative hidden">
          <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
            <Key class="text-2xl text-gray-400" />
          </div>
          <input
            id="confirmPassword"
            name="confirmPassword"
            type="password"
            placeholder="Confirma la contraseña de la URL*"
            class="mt-2 mr-4 block w-full rounded-xl border border-white/10 bg-white/5 px-4 py-3 pr-12 pl-12 text-slate-300 transition-colors outline-none placeholder:text-slate-500 focus:border-purple-500/30 focus:outline-none sm:mb-0"
          />
        </div>
      </div>
      <p
        id="error-message"
        class="mb-3 hidden animate-pulse rounded-lg border border-red-500/20 bg-red-500/10 p-2 text-center text-sm text-red-400"
      >
      </p>
      <button
        id="crear_short"
        type="submit"
        class="w-full rounded-lg bg-linear-to-r from-purple-500 to-blue-500 py-3 shadow-lg shadow-purple-500/20 transition-all hover:from-purple-600 hover:to-blue-600"
      >
        Acortar URL
      </button>
    </div>

    <div
      id="message"
      class="mt-4 flex hidden items-center justify-between rounded-xl border-2 border-purple-500/30 bg-[#1E293B] p-3"
    >
      <span class="text-purple-300"
        ><i class="ti ti-unlink p-2"></i>
        Tu URL acortada es: <span id="short-url" class="font-mono break-all text-blue-300"></span>
      </span>

      <div class="flex items-center gap-2">
        <button
          type="button"
          id="btn-copy"
          class="rounded-md p-1 transition-colors hover:bg-white/10"
          title="Copiar"
        >
          <i class="ti ti-copy w-7 text-[20px] text-blue-300"></i>
        </button>
        <a
          id="btn-open"
          href="#"
          target="_blank"
          class="rounded-md p-1 transition-colors hover:bg-white/10"
          title="Abrir enlace"
        >
          <i class="ti ti-external-link w-6 text-[20px] text-purple-400"></i>
        </a>
      </div>
    </div>
  </form>
</section>

<div
  id="modal"
  class="fixed inset-0 z-50 flex hidden items-center justify-center bg-white/5 backdrop-blur-sm"
>
  <div class="w-96 rounded-lg bg-black/50 p-5 shadow-xl/20 backdrop-blur-sm">
    <h2 class="mb-4 text-lg">Agregar Tag</h2>
    <form id="tag-form" class="space-y-4">
      <input
        id="name-tag"
        name="name-tag"
        type="text"
        placeholder="Nombre del tag"
        class="mb-2 w-full rounded-xl border border-white/10 bg-white/5 p-2 text-slate-300 transition-colors outline-none placeholder:text-stone-500 focus:border-purple-500/30 focus:outline-none"
        required
      />
      <select
        id="select-color-tag"
        name="select-color-tag"
        class="mb-4 flex w-full appearance-none rounded-xl border border-white/10 bg-white/5 p-2 text-slate-300 transition-colors outline-none placeholder:text-stone-500 focus:border-purple-500/30 focus:outline-none"
        required
      >
        <option class="bg-slate-900 text-white" value="" disabled selected
          >Selecciona un color</option
        >
        {
          colors.map((color) => (
            <option style={{ backgroundColor: color.hex, color: 'white' }} value={color.hex}>
              {color.name}
            </option>
          ))
        }
      </select>
      <p
        id="add-tag-error"
        class="hidden animate-pulse rounded-lg border border-red-500/20 bg-red-500/10 p-2 text-center text-sm text-red-400"
      >
      </p>
      <div class="flex justify-end gap-2">
        <button type="button" id="btn-cancel" class="cursor-pointer rounded px-3 py-1"
          >Cancelar</button
        >
        <button
          type="submit"
          class="cursor-pointer rounded-lg bg-linear-to-r from-purple-500 to-blue-500 px-5 py-1 shadow-lg shadow-purple-500/25 transition-all hover:scale-105 hover:from-purple-600 hover:to-blue-600"
          >Guardar</button
        >
      </div>
    </form>
  </div>
</div>

<script>
  import { actions, isInputError } from 'astro:actions'

  document.addEventListener('astro:page-load', () => {
    const tagButton = document.getElementById('add-tag') as HTMLButtonElement
    const modalTag = document.getElementById('modal') as HTMLDivElement
    const cancelTag = document.getElementById('btn-cancel') as HTMLButtonElement
    const tagErrorMsg = document.getElementById('add-tag-error') as HTMLParagraphElement

    tagButton.addEventListener('click', () => {
      modalTag.classList.remove('hidden')
    })
    cancelTag.addEventListener('click', () => {
      modalTag.classList.add('hidden')
      modalForm.reset()
    })

    const modalForm = document.getElementById('tag-form') as HTMLFormElement

    modalForm.addEventListener('submit', async (e) => {
      e.preventDefault()
      tagErrorMsg.classList.add('hidden')
      tagErrorMsg.innerText = ''

      const formData = new FormData(modalForm)

      if (formData) await addTag(formData)
    })

    async function addTag(formData: FormData) {
      const nameTag = formData.get('name-tag') as string
      const colorTag = formData.get('select-color-tag') as string

      const { data, error } = await actions.addTagUser({ nameTag, colorTag })

      if (error) {
        tagErrorMsg.innerText =
          error.status === 400
            ? 'Nombre del tag demasiado largo'
            : error.status === 500
              ? error.message
              : 'Nombre del tag ya existente'

        tagErrorMsg.classList.remove('hidden')
        return
      }

      if (data) {
        const tagSelect = document.getElementById('tag-select') as HTMLSelectElement
        if (tagSelect) {
          const newOption = document.createElement('option')
          newOption.value = data.id
          newOption.textContent = data.name
          newOption.style.backgroundColor = data.color as string
          tagSelect.appendChild(newOption)
          tagSelect.value = data.id
        }
      }
      modalForm.reset()
      modalTag.classList.add('hidden')
    }

    const checkPassword = document.getElementById('password-check') as HTMLInputElement
    const divPass = document.getElementById('passForm') as HTMLDivElement
    const divConPass = document.getElementById('confirmPassForm') as HTMLDivElement
    let passCheck = false

    checkPassword.addEventListener('change', async (e) => {
      e.preventDefault()

      if (checkPassword.checked && checkPassword.checkValidity()) {
        divPass.classList.remove('hidden')
        divConPass.classList.remove('hidden')
        passCheck = true
      } else {
        divPass.classList.add('hidden')
        divConPass.classList.add('hidden')
        passCheck = false
      }
    })

    const shortenForm = document.getElementById('shorten-form') as HTMLFormElement

    const messageDiv = document.getElementById('message') as HTMLDivElement
    const shortUrlSpan = document.getElementById('short-url') as HTMLSpanElement
    const btnCopy = document.getElementById('btn-copy') as HTMLButtonElement
    const btnOpen = document.getElementById('btn-open') as HTMLAnchorElement

    const errorMessage = document.getElementById('error-message') as HTMLParagraphElement

    btnCopy.addEventListener('click', () => {
      const fullShortUrl = btnOpen.href
      navigator.clipboard.writeText(fullShortUrl)
      const icon = btnCopy.querySelector('i')
      if (icon) {
        const originalClass = icon.className
        icon.className = 'w-7 text-[20px] text-blue-400 ti ti-copy-check'
        setTimeout(() => {
          icon.className = originalClass
        }, 2000)
      }
    })

    function showMessage(shortURL: string) {
      const fullShortUrl = `${window.location.origin}/${shortURL}`
      shortUrlSpan.textContent = fullShortUrl
      btnOpen.href = `/${shortURL}`
      messageDiv.classList.remove('hidden')
    }

    function showErrorMessage(message: string) {
      errorMessage.textContent = message
      errorMessage.classList.remove('hidden')
    }

    shortenForm.addEventListener('submit', async (e) => {
      console.log(shortenForm)
      e.preventDefault()

      errorMessage.classList.add('hidden')

      const formData = new FormData(shortenForm)

      if (formData) {
        await setShortUrl(formData)
      }
    })

    async function setShortUrl(formData: FormData) {
      try {
        const url = formData.get('url') as string
        const password = formData.get('password') as string
        const confirmPassword = formData.get('confirmPassword') as string

        const tagIdRaw = formData.get('tagId')
        const tagId = tagIdRaw ? tagIdRaw.toString() : undefined

        if (passCheck) {
          if (!password) {
            showErrorMessage('La contraseña es obligatoria si activas la protección.')
            return
          }
          if (password !== confirmPassword) {
            showErrorMessage('Las contraseñas no coinciden.')
            return
          }
        }

        const { data, error } = await actions.setShortUrlUser({
          url,
          isProtected: passCheck,
          password: passCheck ? password : null,
          tagId,
        })

        if (error) {
          if (isInputError(error)) {
            if (error.fields.url && error.fields.url.length > 0) {
              showErrorMessage(error.fields.url[0])
            } else {
              showErrorMessage('Error de validación en la URL.')
            }
          } else {
            showErrorMessage(error.message)
          }
          return
        }

        if (data) {
          showMessage(data.shortCode)
          shortenForm.reset()

          try {
            // 1. Pedimos el HTML actualizado al servidor (solo la tabla)
            const response = await fetch('/partials/recent-links')
            const newHtml = await response.text()

            // 2. Buscamos el contenedor y reemplazamos el contenido
            const container = document.getElementById('links-table-container')
            if (container) {
              container.innerHTML = newHtml

              // 3. ¡MAGIA! Reactivamos los botones del nuevo HTML
              if (typeof window.initTableEvents === 'function') {
                window.initTableEvents()
              }
            }
          } catch (err) {
            console.error('Error actualizando la tabla:', err)
          }
          divPass.classList.add('hidden')
          divConPass.classList.add('hidden')
          modalForm.reset()
          passCheck = false
        }
      } catch (error) {
        console.error('Error inesperado en el cliente:', error)
        showErrorMessage('Ocurrió un error inesperado. Por favor, intenta de nuevo.')
      }
    }
  })
</script>

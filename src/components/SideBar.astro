---
import { ArroyBackUp, Dashboard, Link, Menu } from '@/icons'

import { db } from '@/db'
import { plan } from '@/db/schema'
import { eq } from 'drizzle-orm'
import SignOutButton from './ui/SignOutButton.astro'

const navItems = [
  {
    icon: Dashboard,
    title: 'Dashboard',
    path: '/dashboard',
  },
  {
    icon: Link,
    title: 'Links',
    path: '/dashboard/links',
  },
]

const { pathname } = Astro.url
const { user } = Astro.locals

let planName = 'Sin plan'
if (user?.planId) {
  const planData = await db.select().from(plan).where(eq(plan.id, user.planId)).limit(1)
  if (planData.length > 0) planName = planData[0].name
}
---

<button
  id="open-sidebar"
  class="fixed top-4 left-4 z-40 rounded-lg bg-slate-800 p-2 text-white shadow-lg hover:bg-slate-700 md:hidden"
  aria-label="Abrir menÃº"
>
  <Menu />
</button>

<div
  id="sidebar-overlay"
  class="fixed inset-0 z-40 hidden bg-black/50 backdrop-blur-sm transition-opacity md:hidden"
>
</div>

<aside
  id="sidebar"
  class="fixed inset-y-0 left-0 z-50 flex bg-white/5 backdrop-blur-sm h-screen w-64 -translate-x-full flex-col border-r border-slate-700/50 transition-transform duration-300 ease-in-out md:sticky top-0 md:translate-x-0"
>
  <div class="flex items-center justify-between gap-2 border-b border-slate-700/50 p-6">
      <a
      transition:name="linkMaster"
      href="/"
      class="bg-linear-to-r justify-start from-purple-400 to-blue-400 bg-clip-text text-xl font-bold text-transparent md:text-2xl lg:text-3xl"
    >
      LinkMaster
      <a id="close-sidebar" class="hover:text-primary justify-end text-sm text-gray-400 transition-colors md:hidden">
        <ArroyBackUp />
      </a>
  </div>

  <nav class="flex-1 p-4">
    <ul class="space-y-2">
      {
        navItems.map((item) => {
          const isActive = pathname === item.path
          return (
            <li>
              <a
                class={`flex w-full items-center gap-3 rounded-lg px-4 py-3 transition-all ${
                  isActive
                    ? 'pointer-events-none border border-purple-500/30 bg-linear-to-r from-purple-500/20 to-blue-500/20 text-purple-300'
                    : 'text-slate-400 hover:bg-slate-700/30 hover:text-white'
                }`}
                href={item.path}
              >
                <item.icon />
                {item.title}
              </a>
            </li>
          )
        })
      }
    </ul>
  </nav>

  <div class="gap-2 border-t border-slate-700/50 p-4">
    <div class="flex items-center justify-between gap-3 px-4 py-3">
      <div class="flex items-center gap-2">
        <div class="text-sm">{user?.name}</div>
        <div class="text-xs text-slate-400">{planName}</div>
      </div>
      <div class="justify-end">
        <SignOutButton
          classButton="p-2 hover:bg-red-500/20"
          classIcon="size-4 group-hover:scale-110"
        />
      </div>
    </div>
  </div>
</aside>

<script>
  
  document.addEventListener('astro:page-load', () => {
  const sidebar = document.getElementById('sidebar')
  const openBtn = document.getElementById('open-sidebar')
  const closeBtn = document.getElementById('close-sidebar')
  const overlay = document.getElementById('sidebar-overlay')

  function toggleSidebar() {
    sidebar?.classList.toggle('-translate-x-full')

    if (overlay?.classList.contains('hidden')) {
      overlay.classList.remove('hidden')
      document.body.classList.add('overflow-hidden')
    } else {
      overlay?.classList.add('hidden')
      document.body.classList.remove('overflow-hidden')

    }
  }

  openBtn?.addEventListener('click', toggleSidebar)
  closeBtn?.addEventListener('click', toggleSidebar)
  overlay?.addEventListener('click', toggleSidebar)
})
</script>

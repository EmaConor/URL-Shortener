---
import Layout from '@/layouts/Layout.astro';
import { auth } from '@/utils/auth';

// Verificación extra en el servidor
const session = await auth.api.getSession({ headers: Astro.request.headers });
if (session?.user.emailVerified) {
    return Astro.redirect('/dashboard');
}

// Obtenemos el email real de la sesión
const emailParam = Astro.url.searchParams.get('email');
const email = session?.user.email || emailParam || 'tu correo';

---

<Layout title="Verificar Email">
    <div class="min-h-screen flex items-center justify-center px-4">
        <div class="max-w-md w-full bg-white/5 border border-white/10 rounded-2xl p-8 backdrop-blur-xl text-center">
            <div class="mx-auto w-16 h-16 bg-purple-500/20 rounded-full flex items-center justify-center mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-purple-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
            </div>

            <h1 class="text-2xl font-bold text-white mb-2">Verifica tu correo</h1>
            <p class="text-slate-400 mb-6">
                Hemos enviado un enlace de confirmación a <span class="text-white font-medium">{email}</span>.
                Por favor, revisa tu bandeja de entrada (y spam).
            </p>

            <div class="space-y-4">
                <button 
                    id="resend-btn" 
                    data-email={email}
                    class="w-full py-3 cursor-pointer rounded-xl bg-white/10 hover:bg-white/20 text-white transition-all font-medium border border-white/5 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    Reenviar correo
                </button>
                
                <a href="/signIn" class="block text-sm text-slate-500 hover:text-slate-300">
                    Volver al inicio de sesión
                </a>
            </div>

            <p id="feedback" class="mt-4 text-sm text-green-400 hidden"></p>
        </div>
    </div>
</Layout>

<script>
    import { authClient } from '@/utils/auth-client';

    document.addEventListener('astro:page-load', async () => {
        // --- LÓGICA 1: VALIDAR TOKEN (Si vienes del click en el email) ---
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        if (token) {
            const title = document.querySelector('h1');
            const p = document.querySelector('p');
            const btnContainer = document.querySelector('.space-y-4');

            if(title) title.innerText = "Verificando...";
            if(p) p.innerText = "Estamos validando tu cuenta, por favor espera.";
            if(btnContainer) btnContainer.classList.add('hidden'); 

            try {
                const { data, error } = await authClient.verifyEmail({
                    query: { token } 
                });

                if (error) {
                    if(title) title.innerText = "Enlace inválido o expirado";
                    if(p) p.innerText = error.message || "Por favor, solicita un nuevo correo.";
                    if(btnContainer) btnContainer.classList.remove('hidden');
                } else {
                    // ÉXITO
                    window.location.href = "/dashboard";
                }
            } catch (err) {
                 if(btnContainer) btnContainer.classList.remove('hidden');
                 if(p) p.innerText = "Error de conexión.";
            }
        }

        // --- LÓGICA 2: REENVIAR EMAIL (Corrección) ---
        const btn = document.getElementById('resend-btn') as HTMLButtonElement;
        const feedback = document.getElementById('feedback');

        if(btn) {
            btn.addEventListener('click', async () => {
                // Recuperamos el email del atributo data-email
                const userEmail = btn.dataset.email;

                if (!userEmail) {
                    alert("Error: No se encontró un email asociado a la sesión.");
                    return;
                }

                btn.disabled = true;
                const originalText = btn.innerText;
                btn.innerText = "Enviando...";

                const { data, error } = await authClient.sendVerificationEmail({
                    email: userEmail, // ¡AQUÍ ESTABA EL ERROR!
                    callbackURL: '/dashboard' // Opcional, asegura el redirect post-verificación
                });

                if (error) {
                    alert("Error: " + error.message);
                    btn.innerText = "Reintentar";
                    btn.disabled = false;
                } else {
                    if(feedback) {
                        feedback.innerText = "¡Correo enviado! Revisa tu bandeja.";
                        feedback.classList.remove('hidden');
                    }
                    btn.innerText = "Enviado correctamente";
                    // Mantenemos deshabilitado unos segundos para evitar spam
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerText = originalText;
                        feedback?.classList.add('hidden');
                    }, 60000); 
                }
            });
        }
    });
</script>
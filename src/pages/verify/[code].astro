---
import Layout from '@/layouts/Layout.astro'

import { db } from '@/db'
import { shortUrl, urlProtection } from '@/db/schema'
import { eq } from 'drizzle-orm'
import { compare } from 'bcryptjs'

const { code } = Astro.params
let error = ''
if (!code) {
  return Astro.redirect('/')
}

const result = await db.select().from(shortUrl).where(eq(shortUrl.code, code)).limit(1)

if (result.length === 0) {
  return Astro.redirect('/404')
}

if (!result[0].isActive) {
  return Astro.redirect('/404')
}

if (Astro.request.method === 'POST') {
  const data = await Astro.request.formData()
  const passwordInput = data.get('password')?.toString()

  if (!passwordInput) {
    error = 'La contrase침a es requerida'
  } else {
    const short = await db
      .select()
      .from(shortUrl)
      .where(eq(shortUrl.code, code))
      .limit(1)

    if (short.length === 0) {
      return Astro.redirect('/404')
    }

    if (!short[0].isProtected) {
      return Astro.redirect(`/${code}`)
    }

    const result = await db
      .select()
      .from(urlProtection)
      .where(eq(urlProtection.urlId, short[0].id))
      .limit(1)

    if (result.length > 0) {
      const isMatch = await compare(passwordInput, result[0].password)

      if (isMatch) {
        Astro.cookies.set(`access_grant_${code}`, 'true', {
          path: '/',
          maxAge: 60 * 60, // 1 hora
          httpOnly: true,
          secure: true, // IMPORTANTE: true solo en producci칩n, false en localhost
          sameSite: 'lax',
        })

        // CORRECCI칍N CLAVE:
        // No redirigimos al destino final, sino a la ruta din치mica original (/${code})
        // para que muestre el contador de 5 segundos.
        return Astro.redirect(`/${code}`)
      } else {
        error = 'Contrase침a incorrecta'
      }
    } else {
      // Caso raro: tiene flag isProtected pero no hay registro en tabla urlProtection
      error = 'Error de configuraci칩n del enlace.'
    }
  }
}
---

<Layout title="Link Protegido">
  <div class="mx-auto mt-20 max-w-md rounded-xl bg-slate-800 p-6 text-center">
    <h1 class="mb-4 text-2xl font-bold text-white">Enlace Protegido 游</h1>
    <p class="mb-6 text-slate-300">Introduce la contrase침a para continuar.</p>

    <form method="POST" class="flex flex-col gap-4">
      <input
        type="password"
        name="password"
        placeholder="Contrase침a..."
        class="rounded border border-slate-600 bg-slate-700 p-3 text-white"
        required
      />
      {error && <p class="text-sm text-red-400">{error}</p>}
      <button
        type="submit"
        class="rounded bg-blue-600 py-2 text-white transition hover:bg-blue-500"
      >
        Desbloquear
      </button>
    </form>
  </div>
</Layout>
